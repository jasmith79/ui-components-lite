import Text from'./text.min.js';import{TooltipMixin}from'./tooltip.min.js';import{FormControlBehavior}from'./form.min.js';import Focusable from'../utils/focusable.min.js';import{inputNormalizer}from'../utils/normalizer.min.js';import{UIBase,document,defineUIComponent,global}from'../utils/ui-component-base.min.js';import{mix}from'../../../mixwith/src/mixwith.js';import{extractType}from'../../../extracttype/extracttype.js';const reflectedAttributes=['label','type','form','placeholder','pattern','required','default-value'],pad=(a)=>(b)=>{const c=''+b;return Number.isNaN(+c)?(console.warn(`Attempted to pad non-numeric argument ${c}.`),''):c.length>=a?c:'0'.repeat(a-c.length)+c},pad2=pad(2),pad4=pad(4),VALID_INPUT_DATE=/^\d{4}\-[0-1][1-9]\-[1-3][1-9]$/,VALID_INPUT_TIME=/^[0-2][0-9]:[0-5][0-9]$/;export const DATE_TYPE_SUPPORTED=(()=>{const a=document.createElement('input'),b='not-a-date';return a.setAttribute('type','date'),a.setAttribute('value',b),a.value!==b})();export const TIME_TYPE_SUPPORTED=(()=>{const a=document.createElement('input'),b='not-a-time';return a.setAttribute('type','time'),a.setAttribute('value',b),a.value!==b})();const destructureDateObj=(a)=>Number.isNaN(a.getTime())?[]:[a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()],formatAsDateInputValue=(a)=>{const[b,c,d]=destructureDateObj(a);return[b,c,d].some((a)=>null==a||Number.isNaN(a))?null:`${pad4(b)}-${pad2(c+1)}-${pad2(d)}`},formatAsDateInputDisplay=(a)=>{const[b,c,d]=destructureDateObj(a);return[b,c,d].some((a)=>null==a||Number.isNaN(a))?null:`${pad2(c+1)}/${pad2(d)}-${pad4(b)}`},formatAsTimeInputValue=(a)=>{const[,,,b,c]=destructureDateObj(a);return[b,c].some((a)=>null==a||Number.isNaN(a))?null:`${pad2(b)}:${pad2(c)}`},formatAsTimeInputDisplay=(a)=>{const[,,,b,c]=destructureDateObj(a);if([b,c].some((a)=>null==a||Number.isNaN(a)))return null;const d=11<b,e=d?'PM':'AM',f=''+(d?b-12:b);return`${pad2(f)}:${pad2(c)} ${e}`},input2Date=(a)=>{if(!a||!a.trim||!a.trim())return null;let b,c,d;return a.includes('/')?[c,d,b]=a.split('/').map(Number):[b,c,d]=a.split('-').map(Number),new Date(b,c-1,d)},parseTimeString=(a)=>{if(!a)return[];let[b,c]=a.split(' '),[d,e]=b.split(':').map(Number),f=c&&'pm'===c.toLowerCase()?12+d:d;return[f,e]},ipv4Validator=(a)=>{if(!a)return!1;if(!a.match(/^[\.\d]+$/))return!1;const b=a.split('.').filter((a)=>a);return 4===b.length&&b.every((a)=>{if(3<a.length)return!1;let b=parseInt(a,10);return!Number.isNaN(b)&&0<=b&&255>=b})},ipv6Validator=(a)=>{if(!a)return!1;let b=a.match(/::/g);if(b&&1<b.length)return!1;if(!a.match(/^(?:::|[a-fA-F0-9]{1,4})[:a-fA-F0-9]*(?:::|[a-fA-F0-9]{1,4})$/))return!1;let c,d=a.split(':').filter((a)=>a);if(8>d.length){let b=a.indexOf('::');if(-1===b)return!1;let e=8-d.length,f=b?'':'0000:'.repeat(e),g=b===a.length-2?':0000'.repeat(e):'';c=f||g?`${f}${a.replace('::','')}${g}`:a.replace('::',`:${'0000:'.repeat(e)}`),d=c.split(':')}return!(8<d.length)&&!d.some((a)=>4<a.length)&&d.map((a)=>parseInt(a,16)).every((a)=>!Number.isNaN(a)&&65536>a&&-1<a)},template=document.createElement('template');template.innerHTML=`
  <style>
    :host {
      display: block;
      border-bottom: solid 1px;
      border-bottom-color: #999;
      min-height: 25px;
      margin-bottom: 10px;
      margin-top: 10px;
      max-width: 200px;
      color: var(--ui-theme-dark-text-color, #333);
      outline-width: 0px;
    }

    :host(.focused) {
      border-bottom-color: var(--ui-theme-primary-dark-color, blue);
      box-shadow: 0px 4px 4px -4px;
    }

    :host(.empty) {
      color: #999;
    }

    ui-text {
      /* janky, I know. TODO: find a way to make this work with transform: translate */
      transition-property: top, left, font-size;
      transition-timing-function: ease;
      transition-duration: 1s;
      position: relative;
      top: 0px;
      left: 0px;
      font-size: 14px;
    }

    #input {
      border: none;
      outline: none;
      width: 90%;
      margin-left: 5%;
      margin-bottom: 3px;
      height: 25px;
      font-size: 16px;
      color: inherit;
      background-color: inherit; /* firefox changes the color */
    }

    .text-moved {
      top: 20px;
      left: 10px;
      font-size: 16px;
    }
  </style>
  <label><ui-text view-text="{{label}}"></ui-text></label>
  <input id="input"/>
`;export const Input=defineUIComponent({name:'ui-input',template,reflectedAttributes,definition:class extends mix(UIBase).with(FormControlBehavior,Focusable,TooltipMixin){constructor(){super(),this._input=null}_typeSetup(a='text'){switch(a.toLowerCase()){case'date':case'time':case'text':case'number':case'password':case'email':case'tel':case'url':this.removeValidator(ipv4Validator),this.removeValidator(ipv6Validator),this._input.setAttribute('type',this.attr('type'));break;case'ipv4':this.removeValidator(ipv6Validator),this.validate(ipv4Validator);break;case'ipv6':this.removeValidator(ipv4Validator),this.validate(ipv6Validator);}return('date'!==this.attr('type').toLowerCase()||DATE_TYPE_SUPPORTED||(this.attr('placeholder','mm/dd/yyyy'),this.attr('pattern','^[0-1][1-9]/[1-3][1-9]/d{4}$')),'time'!==this.attr('type').toLowerCase()||TIME_TYPE_SUPPORTED||(this.attr('placeholder','00:00 AM/PM'),this.attr('pattern','^[0-2][0-9]:[0-5][0-9] [AP]M$')),'hidden'===a)?void this.hide():('date'!==a&&'time'!==a||this.value||this.selectInternalElement('ui-text').classList.remove('text-moved'),this)}get value(){switch((this.attr('type')||'text').toLowerCase()){case'date':return input2Date(super.value);break;case'time':let a=super.value;return a?parseTimeString(a):null;default:return super.value;}}set value(a){let b='';switch((this.attr('type')||'text').toLowerCase()){case'date':switch(extractType(a)){case'Null':case'Undefined':b=null;break;case'Date':b=DATE_TYPE_SUPPORTED?formatAsDateInputValue(a):formatAsDateInputDisplay(a);break;case'String':DATE_TYPE_SUPPORTED||a.match(VALID_INPUT_DATE)?b=a.includes('T')?a.split('T')[0]:a:console.warn(`The specified value "${a}" does not conform to the required format, "yyyy-MM-dd".`);}break;case'time':switch(extractType(a)){case'Array':b=a.length?a.map(pad2).join(':'):'';break;case'String':b=a;break;case'Date':b=destructureDateObj(a).slice(3,5).map(pad2).join(':');}TIME_TYPE_SUPPORTED||b.match(VALID_INPUT_TIME)||console.warn(`The specified value "${a}" does not conform to the required format.  The format is "HH:mm", "HH:mm:ss" or "HH:mm:ss.SSS" where HH is 00-23, mm is 00-59, ss is 00-59, and SSS is 000-999.`);break;default:b=a;}(!0===b||null==b)&&(b=''),!b&&this.defaultValue&&(b=this.defaultValue);const c=(()=>{switch(extractType(b)){case'Array':case'String':return 0===b.length;default:return!1;}})();return c?(this.classList.add('empty'),!this.placeholder&&this.selectInternalElement('ui-text').classList.add('text-moved')):(this.classList.remove('empty'),this.selectInternalElement('ui-text').classList.remove('text-moved')),super.value=b}init(){super.init(),this._input=this.selectInternalElement('#input');const a=this.attr('placeholder')||this.attr('default-value')||null,b=this.attr('type');this.attr('name')&&(!this.attr('label')&&this.attr('label',this.attr('name')),this.selectInternalElement('label').setAttribute('for',this.attr('name'))),a&&(this.placeholder=a),this.attr('label')&&!a&&'date'!==b&&'time'!==b&&this.selectInternalElement('ui-text').classList.add('text-moved'),this.on('focus',()=>{this.selectInternalElement('ui-text').classList.remove('text-moved')}),this.on('blur',()=>{global.setTimeout(()=>{!this.label||this.placeholder||this.value||this.selectInternalElement('ui-text').classList.add('text-moved')},1)}),this.attr('type')||(this.type='text'),this.value&&this.value.length||this.attr('value')||this.classList.add('empty'),this._typeSetup(this.attr('type').toLowerCase()),this._input.addEventListener('focus',()=>{this.classList.add('focused')}),this._input.addEventListener('blur',()=>{this.classList.remove('focused')}),inputNormalizer(this._input),this.on('focus',()=>{this._input.focus()}),this._input.addEventListener('change',()=>{this.value!==this._input.value&&(this.value=this._input.value)}),this.on('attribute-change',({changed:{now:a,name:b,was:c}})=>{let d;switch(b){case'name':this._input.name=a,this.name=a,this.selectInternalElement('label').setAttribute('for',this.name);break;case'value':let c=!0===a?'':a;this._input.value!==c&&(this._input.value=!c&&this.defaultValue?this.defaultValue:c);break;case'default-value':this.value||(this.value=a);break;case'label':d=this.selectInternalElement('ui-text'),!a||this.value||this.placeholder||d.classList.add('text-moved');break;case'placeholder':d=this.selectInternalElement('ui-text'),a&&d.classList.contains('text-moved')&&d.classList.remove('text-moved'),null==a?this._input.removeAttribute(b):this._input.setAttribute(b,a||!0);break;case'type':this._typeSetup(a);break;case'required':null==a?this._input.removeAttribute(b):this._input.setAttribute(b,a||!0);}})}}});